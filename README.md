# RNode-Halow (WIP)

## Реализованный функционал

На текущий момент реализовано следующее:
* Передача и прием широковещательных пакетов по LMAC WiFi Halow
* Ethernet стек функционален
* DHCP клиент
* Протокол KISS-TNC по TCP (порт 8001)
* Прошивка/обновление по OTA (незашифровано)

Что на данный момент отсутсвует:
* Конфигурация - для обновления настроек требуется перекомпилировать прошивку
* Стабильность - проект на ранней стадии разработки
* RNS стек - устройство является просто KISS-TNC TCP модемом
* LBT
* Окна приема/передачи
* Не реализована поддержка подключения по USB, SDIO
* LMAC стек остается загадкой, по хорошему избавиться от проприетарных либ

## Стандартные параметры

Частота 866-867 МГц (ширина канала 1МГц)

PHY WiFi - MCS0

Мощность - 20dBm (нечем проверить, есть вероятность, что ниже)

Порт KISS-TNC TCP - 8001

## Прошивка

ВНИМАНИЕ! Перед прошивкой рекомендуется разобрать одно из устройств и снять дамп SPI флешки!

Для прошивки устройства требуется:

1) Установить npcap, так как для OTA используется нестандартный протокол

https://npcap.com/#download

2) Установить python и зависимости

```pip install -r requirements.txt```

3) Подключить прошиваемое устройство по ethernet в локальную сеть с ПК

4) Запустить скрипт flasher\OTA\rnode-halow-utils.py

5) Выбрать нужное устройство

6) Ввести команду "flash XXXXXXX.bin"

7) Перезагрузить устройство по питанию

Лог правильно прошивки:

```
\flasher\OTA> python.exe .\rnode-halow-utils.py
Commands:
  help                 - show this help
  ls                   - list devices
  flash [FILE]         - flash selected device
  q                    - quit
  <N>                  - select device by number

Scanned devices:
 [1]  ce:4f:26:92:6e:78  v0.0.0.0  "Ethernet"
  2   ce:4f:26:92:5a:78  v0.0.0.0  "Ethernet"

1> flash test.bin

--- confirm ---
device : ce:4f:26:92:6e:78
iface  : Ethernet
ver    : 0.0.0.0
file   : C:\Users\NoName\Documents-laptop\GitHub\TXW8301-PHY\flasher\OTA\test.bin
--------------
flash this file? [y/N]> y
100.00%  276496/276496  2.5 KiB/s
[+] Done.

1>

```

После выполнения этих действий устройство будет прошито, прошивать можно как и RNode-Halow-Firmware, так и оригинальный образ, если требуется откатиться.


## Настройка Reticulum

Дастаточно в интерфейсы вписать конфиг KISS устройства.

Ip адресс можно узнать через DHCP сервер на роутере - устройство имеет hostname "RNode-Halow-XXXXXX", где XXXXXX - последние 3 байта MAC адреса

```
  [[RNode-Halow]]
    type = TCPClientInterface
    enabled = yes
    kiss_framing = True
    target_host = 192.168.XXX.XXX
    target_port = 8001
    fixed_mtu = 508
```

## Для разработчиков

Для простого старта достаточно поставить Taixin CDK и открыть проект в папке "project". Весь необходимый инструментарий содержится в CDK.

Логи идут по UART (IO12, IO13) со скоростью 2'000'000 бод, т.к. логи блокирующие

Для полноценной отладки используется Blue Pill прошитая в CKLink. Чип обязательно должен быть STM32F103C8, C6 не подойдет + китайцы любят пихать отбраковку/клоны с неработающим USB. При включенном WiFi стеке отладка не работает.

Для простой отладки только через UART есть возможность подпаять USB напрямую к выводам IO12, IO13 и использовать утилиту flasher/csky-usb-flasher.exe (исходники пока не готовы к публикации), устройство при этом должно находиться в загрузчике (флешка должна быть забита FF), тогда через zadig поставить драйвер libusbK, прошивка будет грузиться сразу в ОЗУ. Да, UART назначен на те же пины что и USB, в загрузчике это USB, в прошивке UART, поэтому не втыкайте напрямую в USB порты.

Прошивка для OTA генерируется автоматически project/XXXXX.packed.bin после сборки проекта.